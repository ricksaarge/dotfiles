#!/bin/bash
# setup-nvm - Install and configure Node.js via nvm
# Usage: setup-nvm [--latest]
#   --latest: Install latest LTS version
#   (default): Install pinned version 22.11.0

set -euo pipefail

_info() { echo "[INFO] $1"; }
_error() { echo "[ERROR] $1" >&2; exit 1; }
_success() { echo "[SUCCESS] $1"; }

# Check if nvm is installed
if [[ ! -d "$HOME/.nvm" ]]; then
	_error "nvm not found. Install with: brew install nvm"
fi

# Source nvm for this script
export NVM_DIR="$HOME/.nvm"
if [[ -s "/opt/homebrew/opt/nvm/nvm.sh" ]]; then
	source "/opt/homebrew/opt/nvm/nvm.sh"
elif [[ -s "$NVM_DIR/nvm.sh" ]]; then
	source "$NVM_DIR/nvm.sh"
else
	_error "nvm.sh not found"
fi

# Pinned Node.js version (used by default)
PINNED_VERSION="22.11.0"

# Determine version to install
if [[ "${1:-}" == "--latest" ]]; then
	_info "Installing latest Node.js LTS version..."
	nvm install --lts
	NODE_VERSION="lts/*"
	_info "Setting latest LTS as default version..."
	nvm alias default lts/*
else
	_info "Installing Node.js $PINNED_VERSION..."
	nvm install "$PINNED_VERSION"
	NODE_VERSION="$PINNED_VERSION"
	_info "Setting Node.js $PINNED_VERSION as default version..."
	nvm alias default "$PINNED_VERSION"
fi

_info "Using default Node.js version..."
nvm use default

# Verify installation
node_version=$(node --version)
npm_version=$(npm --version)

_success "Node.js $node_version installed"
_success "npm $npm_version installed"
_info "Default version: $(nvm version default)"
