#!/bin/bash
# setup-pyenv - Install and configure Python via pyenv
# Usage: setup-pyenv [--latest]
#   --latest: Install latest stable Python version
#   (default): Install pinned version 3.13.0

set -euo pipefail

_info() { echo "[INFO] $1"; }
_error() { echo "[ERROR] $1" >&2; exit 1; }
_success() { echo "[SUCCESS] $1"; }

# Check if pyenv is installed
if ! command -v pyenv &> /dev/null; then
	_error "pyenv not found. Install with: brew install pyenv"
fi

# Initialize pyenv for this script
export PYENV_ROOT="$HOME/.pyenv"
export PATH="$PYENV_ROOT/bin:$PATH"
eval "$(pyenv init -)"

# Pinned Python version (used by default)
PINNED_VERSION="3.13.0"

# Determine version to install
if [[ "${1:-}" == "--latest" ]]; then
	_info "Fetching latest stable Python version..."
	PYTHON_VERSION=$(pyenv install --list | grep -E '^\s*[0-9]+\.[0-9]+\.[0-9]+$' | tail -1 | tr -d '[:space:]')

	if [[ -z "$PYTHON_VERSION" ]]; then
		_error "Could not determine latest Python version"
	fi

	_info "Installing Python $PYTHON_VERSION..."
	pyenv install --skip-existing "$PYTHON_VERSION"

	_info "Setting Python $PYTHON_VERSION as global default..."
	pyenv global "$PYTHON_VERSION"
else
	_info "Installing Python $PINNED_VERSION..."
	pyenv install --skip-existing "$PINNED_VERSION"

	_info "Setting Python $PINNED_VERSION as global default..."
	pyenv global "$PINNED_VERSION"
fi

# Verify installation
python_version=$(python --version)
pip_version=$(pip --version | awk '{print $2}')

_success "$python_version installed"
_success "pip $pip_version installed"
_info "Global version: $(pyenv global)"

_info "Updating pip to latest version..."
pip install --upgrade pip --quiet

_success "Setup complete!"
