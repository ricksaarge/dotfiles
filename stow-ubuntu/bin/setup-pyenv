#!/bin/bash
# setup-pyenv - Install and configure Python via pyenv (Ubuntu)
# Installs latest stable Python version and sets as global default

set -euo pipefail

_info() { echo "[INFO] $1"; }
_error() { echo "[ERROR] $1" >&2; exit 1; }
_success() { echo "[SUCCESS] $1"; }

# Install pyenv if not present
if ! command -v pyenv &> /dev/null; then
	_info "Installing pyenv..."
	curl https://pyenv.run | bash

	# Initialize pyenv for this script
	export PYENV_ROOT="$HOME/.pyenv"
	export PATH="$PYENV_ROOT/bin:$PATH"
	eval "$(pyenv init -)"
else
	# Initialize pyenv for this script
	export PYENV_ROOT="$HOME/.pyenv"
	export PATH="$PYENV_ROOT/bin:$PATH"
	eval "$(pyenv init -)"
fi

_info "Fetching latest stable Python version..."
latest_python=$(pyenv install --list | grep -E '^\s*[0-9]+\.[0-9]+\.[0-9]+$' | tail -1 | tr -d '[:space:]')

if [[ -z "$latest_python" ]]; then
	_error "Could not determine latest Python version"
fi

_info "Installing Python $latest_python..."
pyenv install --skip-existing "$latest_python"

_info "Setting Python $latest_python as global default..."
pyenv global "$latest_python"

# Verify installation
python_version=$(python --version)
pip_version=$(pip --version | awk '{print $2}')

_success "$python_version installed"
_success "pip $pip_version installed"
_info "Global version: $(pyenv global)"

_info "Updating pip to latest version..."
pip install --upgrade pip --quiet

_success "Setup complete!"
